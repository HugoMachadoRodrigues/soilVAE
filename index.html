<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>soilVAE ‚Ä¢ soilVAE</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="soilVAE">
<meta name="description" content="Supervised VAE regression (Keras/TensorFlow via reticulate) for soil spectroscopy and high-dimensional predictors.">
<meta property="og:description" content="Supervised VAE regression (Keras/TensorFlow via reticulate) for soil spectroscopy and high-dimensional predictors.">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">soilVAE</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/HugoMachadoRodrigues/soilVAE/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="soilvae-">soilVAE <img src="reference/figures/Badge_soilVAE_2.png" alt="soilVAE badge" align="right" width="287"><a class="anchor" aria-label="anchor" href="#soilvae-"></a>
</h1></div>
<p><a href="https://CRAN.R-project.org/package=soilVAE" class="external-link"><img src="https://www.r-pkg.org/badges/version/soilVAE" alt="CRAN status"></a> <a href="https://github.com/HugoMachadoRodrigues/soilVAE/actions/workflows/R-CMD-check.yaml" class="external-link"><img src="https://github.com/HugoMachadoRodrigues/soilVAE/actions/workflows/R-CMD-check.yaml/badge.svg" alt="R-CMD-check"></a> <a href="https://doi.org/10.5281/zenodo.187115457" class="external-link"><img src="https://zenodo.org/badge/DOI/10.5281/zenodo.187115457.svg" alt="DOI"></a> <img src="https://img.shields.io/badge/Python-%3E%3D3.9-blue" alt="Python"><img src="https://img.shields.io/badge/TensorFlow-%3E%3D2.13-orange" alt="TensorFlow"></p>
<!-- badges: end -->
<p>Supervised <strong>Variational Autoencoder (VAE)</strong> regression for high‚Äëdimensional predictors (e.g., VIS‚ÄìNIR‚ÄìSWIR soil spectroscopy), implemented in <strong>Python TensorFlow/Keras</strong> and exposed in R via <strong>reticulate</strong>.</p>
<p>The README is also the <strong>main reproducible case study</strong>, mirroring the vignette (<code>vignettes/soilVAE-workflow.Rmd</code>) so a reader can understand the <em>why</em>, <em>how</em>, and <em>performance</em> without opening additional files.</p>
<hr>
<div class="section level2">
<h2 id="what-soilvae-does">What soilVAE does<a class="anchor" aria-label="anchor" href="#what-soilvae-does"></a>
</h2>
<p>Given spectra <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>‚àà</mo><msup><mi>‚Ñù</mi><mi>p</mi></msup></mrow><annotation encoding="application/x-tex">x\in\mathbb{R}^p</annotation></semantics></math> and a continuous soil property <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>‚àà</mo><mi>‚Ñù</mi></mrow><annotation encoding="application/x-tex">y\in\mathbb{R}</annotation></semantics></math>, soilVAE learns:</p>
<ul>
<li>an encoder <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>q</mi><mi>œï</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo>‚à£</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">q_\phi(z\mid x)</annotation></semantics></math> mapping spectra to a latent embedding <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi><mo>‚àà</mo><msup><mi>‚Ñù</mi><mi>d</mi></msup></mrow><annotation encoding="application/x-tex">z\in\mathbb{R}^d</annotation></semantics></math>
</li>
<li>a decoder <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>Œ∏</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo>‚à£</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">p_\theta(x\mid z)</annotation></semantics></math> reconstructing spectra</li>
<li>a supervised head <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>y</mi><mo accent="true">ÃÇ</mo></mover><mo>=</mo><msub><mi>f</mi><mi>œà</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\hat y = f_\psi(z)</annotation></semantics></math> predicting the property</li>
</ul>
<div class="section level3">
<h3 id="objective-supervised-beta-vae">Objective (supervised <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Œ≤</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>-VAE)<a class="anchor" aria-label="anchor" href="#objective-supervised-beta-vae"></a>
</h3>
<p>We minimize a weighted sum:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>‚Ñí</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><munder><munder><mrow><mo stretchy="false" form="postfix">‚à•</mo><mi>x</mi><mo>‚àí</mo><mover><mi>x</mi><mo accent="true">ÃÇ</mo></mover><msubsup><mo stretchy="false" form="postfix">‚à•</mo><mn>2</mn><mn>2</mn></msubsup></mrow><mo accent="true">‚èü</mo></munder><mtext mathvariant="normal">reconstruction</mtext></munder><mspace width="0.278em"></mspace><mo>+</mo><mspace width="0.278em"></mspace><mi>Œ≤</mi><mspace width="0.278em"></mspace><munder><munder><mrow><msub><mi>D</mi><mrow><mi>K</mi><mi>L</mi></mrow></msub><mspace width="-0.167em"></mspace><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>q</mi><mi>œï</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo>‚à£</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow><mspace width="0.167em"></mspace><mo stretchy="false" form="postfix">‚à•</mo><mspace width="0.167em"></mspace><mi>ùí©</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mi>I</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mo accent="true">‚èü</mo></munder><mtext mathvariant="normal">regularization</mtext></munder><mspace width="0.278em"></mspace><mo>+</mo><mspace width="0.278em"></mspace><mi>Œ±</mi><mspace width="0.278em"></mspace><munder><munder><mrow><mo stretchy="false" form="postfix">‚à•</mo><mi>y</mi><mo>‚àí</mo><mover><mi>y</mi><mo accent="true">ÃÇ</mo></mover><msubsup><mo stretchy="false" form="postfix">‚à•</mo><mn>2</mn><mn>2</mn></msubsup></mrow><mo accent="true">‚èü</mo></munder><mtext mathvariant="normal">regression</mtext></munder><mi>.</mi></mrow><annotation encoding="application/x-tex">
\mathcal{L}(x,y) =
\underbrace{\|x-\hat x\|_2^2}_{\text{reconstruction}}
\;+\;
\beta\;\underbrace{D_{KL}\!\left(q_\phi(z\mid x)\,\|\,\mathcal{N}(0,I)\right)}_{\text{regularization}}
\;+\;
\alpha\;\underbrace{\|y-\hat y\|_2^2}_{\text{regression}}.
</annotation></semantics></math></p>
<p>In the package API, these correspond to <code>beta_kl = Œ≤</code> and <code>alpha_y = Œ±</code>.</p>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<div class="section level3">
<h3 id="cran-once-accepted">CRAN (once accepted)<a class="anchor" aria-label="anchor" href="#cran-once-accepted"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"soilVAE"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="development-version-github">Development version (GitHub)<a class="anchor" aria-label="anchor" href="#development-version-github"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("remotes")</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"HugoMachadoRodrigues/soilVAE"</span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="python--tensorflow-setup-that-does-not-surprise-the-user">Python / TensorFlow setup that does <em>not</em> surprise the user<a class="anchor" aria-label="anchor" href="#python--tensorflow-setup-that-does-not-surprise-the-user"></a>
</h2>
<p>Because deep learning depends on external Python libraries, this README uses a <strong>defensive pattern</strong>:</p>
<ol style="list-style-type: decimal">
<li>detect whether Python + TF/Keras are available<br>
</li>
<li>if not, show <em>exactly</em> how to create a conda env using <strong>conda-forge only</strong><br>
</li>
<li>run the VAE only when the environment is ready</li>
</ol>
<blockquote>
<p><strong>Important</strong>: <code>reticulate</code> ‚Äúlocks‚Äù the Python used <strong>per R session</strong>. If you change env variables or <code>use_*()</code> calls, restart R.</p>
</blockquote>
<div class="section level3">
<h3 id="option-a-recommended-conda-env-conda-forge-only">Option A (recommended): conda env (conda-forge only)<a class="anchor" aria-label="anchor" href="#option-a-recommended-conda-env-conda-forge-only"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/reticulate/" class="external-link">reticulate</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make sure reticulate isn't forced to a missing python</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.unsetenv</a></span><span class="op">(</span><span class="st">"RETICULATE_PYTHON"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create env (if needed)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="st">"soilvae-tf"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rstudio.github.io/reticulate/reference/conda-tools.html" class="external-link">conda_list</a></span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">name</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rstudio.github.io/reticulate/reference/conda-tools.html" class="external-link">conda_create</a></span><span class="op">(</span><span class="st">"soilvae-tf"</span>, python_version <span class="op">=</span> <span class="st">"3.11"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Install core deps from conda-forge</span></span>
<span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/conda-tools.html" class="external-link">conda_install</a></span><span class="op">(</span><span class="st">"soilvae-tf"</span>, packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pip"</span>, <span class="st">"numpy"</span><span class="op">)</span>, channel <span class="op">=</span> <span class="st">"conda-forge"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Install TF/Keras via pip inside the env</span></span>
<span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/py_install.html" class="external-link">py_install</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"tensorflow&gt;=2.13"</span>, <span class="st">"keras&gt;=3"</span><span class="op">)</span>, pip <span class="op">=</span> <span class="cn">TRUE</span>, envname <span class="op">=</span> <span class="st">"soilvae-tf"</span><span class="op">)</span></span></code></pre></div>
<p>Now, in the same R session:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://hugomachadorodrigues.github.io/soilVAE">soilVAE</a></span><span class="op">)</span></span>
<span><span class="fu">soilVAE</span><span class="fu">::</span><span class="fu"><a href="reference/vae_configure.html">vae_configure</a></span><span class="op">(</span>conda <span class="op">=</span> <span class="st">"soilvae-tf"</span><span class="op">)</span></span>
<span><span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/py_config.html" class="external-link">py_config</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="option-b-point-to-an-existing-python-executable">Option B: point to an existing Python executable<a class="anchor" aria-label="anchor" href="#option-b-point-to-an-existing-python-executable"></a>
</h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://hugomachadorodrigues.github.io/soilVAE">soilVAE</a></span><span class="op">)</span></span>
<span><span class="fu">soilVAE</span><span class="fu">::</span><span class="fu"><a href="reference/vae_configure.html">vae_configure</a></span><span class="op">(</span>python <span class="op">=</span> <span class="st">"C:/path/to/python.exe"</span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="reproducible-case-study-spectra---pre-processing---pls-baseline---soilvae">Reproducible case study (spectra -&gt; pre-processing -&gt; PLS baseline -&gt; soilVAE)<a class="anchor" aria-label="anchor" href="#reproducible-case-study-spectra---pre-processing---pls-baseline---soilvae"></a>
</h2>
<p>This follows the workflow style commonly used in soil spectral inference tutorials (e.g., Wadoux et al., 2021) (Wadoux et al.¬†2021), with a direct comparison between a <strong>PLS baseline</strong> and <strong>soilVAE</strong>.</p>
<div class="section level3">
<h3 id="packages">Packages<a class="anchor" aria-label="anchor" href="#packages"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">19101991</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pkgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"prospectr"</span>, <span class="st">"pls"</span>, <span class="st">"reticulate"</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">p</span> <span class="kw">in</span> <span class="va">pkgs</span><span class="op">)</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="va">p</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/l-ramirez-lopez/prospectr" class="external-link">prospectr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/khliland/pls" class="external-link">pls</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/reticulate/" class="external-link">reticulate</a></span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"soilVAE"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"soilVAE is not installed. Install it with remotes::install_github('HugoMachadoRodrigues/soilVAE')."</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://hugomachadorodrigues.github.io/soilVAE">soilVAE</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Defensive: detect Python + TF/Keras early, so the README can render everywhere.</span></span>
<span><span class="va">has_py</span> <span class="op">&lt;-</span> <span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/py_available.html" class="external-link">py_available</a></span><span class="op">(</span>initialize <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">has_tf</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">has_py</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/py_config.html" class="external-link">py_config</a></span><span class="op">(</span><span class="op">)</span>, silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">has_tf</span> <span class="op">&lt;-</span> <span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/py_module_available.html" class="external-link">py_module_available</a></span><span class="op">(</span><span class="st">"tensorflow"</span><span class="op">)</span> <span class="op">&amp;&amp;</span></span>
<span>    <span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/py_module_available.html" class="external-link">py_module_available</a></span><span class="op">(</span><span class="st">"keras"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h3>
<p>This example assumes you ship <code>datsoilspc</code> inside the package (<code>data/datsoilspc.rda</code>).</p>
<p>This dataset is provided and described at Geeves et al.¬†(1995)</p>
<p><em>Geeves, G. W. (Guy W.) &amp; New South Wales. Department of Conservation and Land Management &amp; CSIRO. Division of Soils. (1995). The physical, chemical and morphological properties of soils in the wheat-belt of southern N.S.W. and northern Victoria / G.W. Geeves ‚Ä¶ [et al.]. Glen Osmond, S. Aust. : CSIRO Division of Soils</em></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"datsoilspc"</span>, package <span class="op">=</span> <span class="st">"soilVAE"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">datsoilspc</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    391 obs. of  5 variables:</span></span>
<span><span class="co">#&gt;  $ clay       : num  49 7 56 14 53 24 9 18 33 27 ...</span></span>
<span><span class="co">#&gt;  $ silt       : num  10 24 17 19 7 21 9 20 13 19 ...</span></span>
<span><span class="co">#&gt;  $ sand       : num  42 69 27 67 40 55 83 61 54 55 ...</span></span>
<span><span class="co">#&gt;  $ TotalCarbon: num  0.15 0.12 0.17 1.06 0.69 2.76 0.66 1.36 0.19 0.16 ...</span></span>
<span><span class="co">#&gt;  $ spc        : num [1:391, 1:2151] 0.0898 0.1677 0.0778 0.0958 0.0359 ...</span></span>
<span><span class="co">#&gt;   ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">#&gt;   .. ..$ : NULL</span></span>
<span><span class="co">#&gt;   .. ..$ : chr [1:2151] "350" "351" "352" "353" ...</span></span>
<span><span class="co">#&gt;  - attr(*, "na.action")= 'omit' Named int 392</span></span>
<span><span class="co">#&gt;   ..- attr(*, "names")= chr "63"</span></span></code></pre></div>
<p>Expected structure:</p>
<ul>
<li>
<code>datsoilspc$spc</code>: matrix of reflectance spectra (rows = samples; cols = wavelengths)</li>
<li>
<code>datsoilspc$TotalCarbon</code>: numeric target (example property)</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="utility-evaluation-metrics-base-r">Utility: evaluation metrics (base R)<a class="anchor" aria-label="anchor" href="#utility-evaluation-metrics-base-r"></a>
</h2>
<p>We replicate typical ‚Äúquantitative‚Äù metrics used in soil spectroscopy:<br>
RMSE, MAE, R¬≤, bias (ME), RPIQ, and RPD.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eval_quant</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span>, <span class="va">yhat</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span>  <span class="va">yhat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">yhat</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">ok</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">yhat</span><span class="op">)</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">ok</span><span class="op">]</span></span>
<span>  <span class="va">yhat</span> <span class="op">&lt;-</span> <span class="va">yhat</span><span class="op">[</span><span class="va">ok</span><span class="op">]</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">3</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>,</span>
<span>      ME <span class="op">=</span> <span class="cn">NA_real_</span>, MAE <span class="op">=</span> <span class="cn">NA_real_</span>, RMSE <span class="op">=</span> <span class="cn">NA_real_</span>,</span>
<span>      R2 <span class="op">=</span> <span class="cn">NA_real_</span>, RPIQ <span class="op">=</span> <span class="cn">NA_real_</span>, RPD <span class="op">=</span> <span class="cn">NA_real_</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">err</span> <span class="op">&lt;-</span> <span class="va">yhat</span> <span class="op">-</span> <span class="va">y</span></span>
<span>  <span class="va">me</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">err</span><span class="op">)</span></span>
<span>  <span class="va">mae</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">err</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">rmse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">err</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">ss_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">y</span> <span class="op">-</span> <span class="va">yhat</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">ss_tot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">y</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">r2</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">ss_tot</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="cn">NA_real_</span> <span class="kw">else</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">ss_res</span> <span class="op">/</span> <span class="va">ss_tot</span></span>
<span></span>
<span>  <span class="va">rpiq</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/IQR.html" class="external-link">IQR</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">/</span> <span class="va">rmse</span></span>
<span>  <span class="va">rpd</span>  <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">/</span> <span class="va">rmse</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>,</span>
<span>    ME <span class="op">=</span> <span class="va">me</span>,</span>
<span>    MAE <span class="op">=</span> <span class="va">mae</span>,</span>
<span>    RMSE <span class="op">=</span> <span class="va">rmse</span>,</span>
<span>    R2 <span class="op">=</span> <span class="va">r2</span>,</span>
<span>    RPIQ <span class="op">=</span> <span class="va">rpiq</span>,</span>
<span>    RPD <span class="op">=</span> <span class="va">rpd</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">as_df_metrics</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="va">x</span><span class="op">$</span><span class="va">n</span>,</span>
<span>    ME <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">ME</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    MAE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">MAE</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    RMSE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">RMSE</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    R2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">R2</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    RPIQ <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">RPIQ</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    RPD <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">RPD</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div class="section level1">
<h1 id="plot-reflectance-spectra">Plot reflectance spectra<a class="anchor" aria-label="anchor" href="#plot-reflectance-spectra"></a>
</h1>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">datsoilspc</span><span class="op">$</span><span class="va">spc</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">datsoilspc</span><span class="op">$</span><span class="va">spc</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">"Wavelength / nm"</span>,</span>
<span>  ylab <span class="op">=</span> <span class="st">"Reflectance"</span>,</span>
<span>  ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>  lty <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html" class="external-link">rgb</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="reference/figures/readme-spectrum_plot-1.png" alt="Raw reflectance spectra (datsoilspc$spc)"><p class="caption">
Raw reflectance spectra (datsoilspc$spc)
</p>
</div>
</div>
<div class="section level1">
<h1 id="convert-reflectance-to-absorbance">Convert reflectance to absorbance<a class="anchor" aria-label="anchor" href="#convert-reflectance-to-absorbance"></a>
</h1>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">datsoilspc</span><span class="op">$</span><span class="va">spcA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">datsoilspc</span><span class="op">$</span><span class="va">spc</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">datsoilspc</span><span class="op">$</span><span class="va">spcA</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">datsoilspc</span><span class="op">$</span><span class="va">spcA</span><span class="op">)</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">"Wavelength / nm"</span>,</span>
<span>  ylab <span class="op">=</span> <span class="st">"Absorbance"</span>,</span>
<span>  ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>  lty <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html" class="external-link">rgb</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="reference/figures/readme-absorbance_plot-1.png" alt="Absorbance spectra (datsoilspc$spcA)"><p class="caption">
Absorbance spectra (datsoilspc$spcA)
</p>
</div>
</div>
<div class="section level1">
<h1 id="preprocessing-resample-5-nm--snv--moving-average">Preprocessing: resample (5 nm) + SNV + moving average<a class="anchor" aria-label="anchor" href="#preprocessing-resample-5-nm--snv--moving-average"></a>
</h1>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">oldWavs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">datsoilspc</span><span class="op">$</span><span class="va">spcA</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">newWavs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">oldWavs</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">oldWavs</span><span class="op">)</span>, by <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">datsoilspc</span><span class="op">$</span><span class="va">spcARs</span> <span class="op">&lt;-</span> <span class="fu">prospectr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/prospectr/man/resample.html" class="external-link">resample</a></span><span class="op">(</span></span>
<span>  X <span class="op">=</span> <span class="va">datsoilspc</span><span class="op">$</span><span class="va">spcA</span>,</span>
<span>  wav <span class="op">=</span> <span class="va">oldWavs</span>,</span>
<span>  new.wav <span class="op">=</span> <span class="va">newWavs</span>,</span>
<span>  interpol <span class="op">=</span> <span class="st">"linear"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">datsoilspc</span><span class="op">$</span><span class="va">spcASnv</span> <span class="op">&lt;-</span> <span class="fu">prospectr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/prospectr/man/standardNormalVariate.html" class="external-link">standardNormalVariate</a></span><span class="op">(</span><span class="va">datsoilspc</span><span class="op">$</span><span class="va">spcARs</span><span class="op">)</span></span>
<span><span class="va">datsoilspc</span><span class="op">$</span><span class="va">spcAMovav</span> <span class="op">&lt;-</span> <span class="fu">prospectr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/prospectr/man/movav.html" class="external-link">movav</a></span><span class="op">(</span><span class="va">datsoilspc</span><span class="op">$</span><span class="va">spcASnv</span>, w <span class="op">=</span> <span class="fl">11</span><span class="op">)</span></span>
<span></span>
<span><span class="va">wavs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">datsoilspc</span><span class="op">$</span><span class="va">spcAMovav</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">wavs</span>,</span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">datsoilspc</span><span class="op">$</span><span class="va">spcAMovav</span><span class="op">)</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">"Wavelength / nm"</span>,</span>
<span>  ylab <span class="op">=</span> <span class="st">"Absorbance (SNV + movav)"</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>  lty <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html" class="external-link">rgb</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="reference/figures/readme-preprocess_plot-1.png" alt="Preprocessed spectra (datsoilspc$spcAMovav)"><p class="caption">
Preprocessed spectra (datsoilspc$spcAMovav)
</p>
</div>
</div>
<div class="section level1">
<h1 id="split-calibration-vs-validation">Split calibration vs validation<a class="anchor" aria-label="anchor" href="#split-calibration-vs-validation"></a>
</h1>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">19101991</span><span class="op">)</span></span>
<span></span>
<span><span class="va">calId</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">datsoilspc</span><span class="op">)</span><span class="op">)</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">0.75</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">datsoilspc</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">datC</span> <span class="op">&lt;-</span> <span class="va">datsoilspc</span><span class="op">[</span><span class="va">calId</span>, <span class="op">]</span></span>
<span><span class="va">datV</span> <span class="op">&lt;-</span> <span class="va">datsoilspc</span><span class="op">[</span><span class="op">-</span><span class="va">calId</span>, <span class="op">]</span>  <span class="co"># &lt;-- TEST</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">datC</span><span class="op">$</span><span class="va">TotalCarbon</span>, main <span class="op">=</span> <span class="st">"Calibration (datC)"</span>, xlab <span class="op">=</span> <span class="st">"Total carbon"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">datV</span><span class="op">$</span><span class="va">TotalCarbon</span>, main <span class="op">=</span> <span class="st">"TEST (datV)"</span>, xlab <span class="op">=</span> <span class="st">"Total carbon"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="reference/figures/readme-Splits-1.png" alt="Calibration vs TEST splits (datC vs datV)"><p class="caption">
Calibration vs TEST splits (datC vs datV)
</p>
</div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level1">
<h1 id="baseline-model-pls">Baseline model: PLS<a class="anchor" aria-label="anchor" href="#baseline-model-pls"></a>
</h1>
<p>We fit PLS on calibration and evaluate on validation.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">maxc</span> <span class="op">&lt;-</span> <span class="fl">30</span></span>
<span></span>
<span><span class="va">soilCPlsModel</span> <span class="op">&lt;-</span> <span class="fu">pls</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pls/man/mvr.html" class="external-link">plsr</a></span><span class="op">(</span></span>
<span>  <span class="va">TotalCarbon</span> <span class="op">~</span> <span class="va">spcAMovav</span>,</span>
<span>  data <span class="op">=</span> <span class="va">datC</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"oscorespls"</span>,</span>
<span>  ncomp <span class="op">=</span> <span class="va">maxc</span>,</span>
<span>  validation <span class="op">=</span> <span class="st">"CV"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">soilCPlsModel</span>, <span class="st">"val"</span>, main <span class="op">=</span> <span class="st">"PLS CV performance (datC)"</span>, xlab <span class="op">=</span> <span class="st">"Number of components"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="reference/figures/readme-pls_cv-1.png" alt="PLS CV performance (datC)"><p class="caption">
PLS CV performance (datC)
</p>
</div>
</div>
<div class="section level1">
<h1 id="choose-number-of-components-example-uses-nc--14">Choose number of components (example uses <code>nc = 14</code>).<a class="anchor" aria-label="anchor" href="#choose-number-of-components-example-uses-nc--14"></a>
</h1>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nc</span> <span class="op">&lt;-</span> <span class="fl">14</span></span>
<span></span>
<span><span class="co"># Refit on full datC with chosen nc (PLS itself uses all comps up to maxc; prediction uses nc)</span></span>
<span><span class="va">soilCPlsPred_C</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">soilCPlsModel</span>, ncomp <span class="op">=</span> <span class="va">nc</span>, newdata <span class="op">=</span> <span class="va">datC</span><span class="op">$</span><span class="va">spcAMovav</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">soilCPlsPred_T</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">soilCPlsModel</span>, ncomp <span class="op">=</span> <span class="va">nc</span>, newdata <span class="op">=</span> <span class="va">datV</span><span class="op">$</span><span class="va">spcAMovav</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">datC</span><span class="op">$</span><span class="va">TotalCarbon</span>, <span class="va">soilCPlsPred_C</span>, xlab<span class="op">=</span><span class="st">"Observed"</span>, ylab<span class="op">=</span><span class="st">"Predicted"</span>, main<span class="op">=</span><span class="st">"PLS (datC)"</span>, pch<span class="op">=</span><span class="fl">16</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">datV</span><span class="op">$</span><span class="va">TotalCarbon</span>, <span class="va">soilCPlsPred_T</span>, xlab<span class="op">=</span><span class="st">"Observed"</span>, ylab<span class="op">=</span><span class="st">"Predicted"</span>, main<span class="op">=</span><span class="st">"PLS (TEST datV)"</span>, pch<span class="op">=</span><span class="fl">16</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="reference/figures/readme-pls_pred-1.png" alt="PLS predictions (datC + datV)"><p class="caption">
PLS predictions (datC + datV)
</p>
</div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level1">
<h1 id="metrics-pls">Metrics (PLS)<a class="anchor" aria-label="anchor" href="#metrics-pls"></a>
</h1>
<p>We use the same evaluation function used in many soilspec workflows.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pls_cal</span> <span class="op">&lt;-</span> <span class="fu">eval_quant</span><span class="op">(</span><span class="va">datC</span><span class="op">$</span><span class="va">TotalCarbon</span>, <span class="va">soilCPlsPred_C</span><span class="op">)</span></span>
<span><span class="va">pls_tst</span> <span class="op">&lt;-</span> <span class="fu">eval_quant</span><span class="op">(</span><span class="va">datV</span><span class="op">$</span><span class="va">TotalCarbon</span>, <span class="va">soilCPlsPred_T</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">as_df_metrics</span><span class="op">(</span><span class="va">pls_cal</span><span class="op">)</span></span>
<span><span class="co">#&gt;     n ME  MAE RMSE   R2 RPIQ  RPD</span></span>
<span><span class="co">#&gt; 1 293  0 0.37 0.56 0.86 2.04 2.63</span></span>
<span><span class="fu">as_df_metrics</span><span class="op">(</span><span class="va">pls_tst</span><span class="op">)</span></span>
<span><span class="co">#&gt;    n   ME  MAE RMSE   R2 RPIQ  RPD</span></span>
<span><span class="co">#&gt; 1 98 0.02 0.36 0.52 0.69 2.34 1.81</span></span></code></pre></div>
</div>
<div class="section level1">
<h1 id="supervised-vae-regression-soilvae">Supervised VAE regression: soilVAE<a class="anchor" aria-label="anchor" href="#supervised-vae-regression-soilvae"></a>
</h1>
<div class="section level3">
<h3 id="availability-check-tensorflowkeras">Availability check (TensorFlow/Keras)<a class="anchor" aria-label="anchor" href="#availability-check-tensorflowkeras"></a>
</h3>
<p>This chunk detects if Python + TensorFlow + Keras can be loaded.<br>
If not available, the VAE section is skipped (vignette still builds).</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">has_py</span> <span class="op">&lt;-</span> <span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/py_available.html" class="external-link">py_available</a></span><span class="op">(</span>initialize <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">has_tf</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">has_py</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/py_config.html" class="external-link">py_config</a></span><span class="op">(</span><span class="op">)</span>, silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">has_tf</span> <span class="op">&lt;-</span> <span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/py_module_available.html" class="external-link">py_module_available</a></span><span class="op">(</span><span class="st">"tensorflow"</span><span class="op">)</span> <span class="op">&amp;&amp;</span></span>
<span>            <span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/py_module_available.html" class="external-link">py_module_available</a></span><span class="op">(</span><span class="st">"keras"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">has_py</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="va">has_tf</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="prepare-matrices-same-predictors-as-pls-preprocessing">Prepare matrices (same predictors as PLS preprocessing)<a class="anchor" aria-label="anchor" href="#prepare-matrices-same-predictors-as-pls-preprocessing"></a>
</h3>
<p>Prepare Train/Val internal split within datC (no y transform; scale X only)</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">19101991</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">datC</span><span class="op">)</span></span>
<span><span class="va">id_tr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">nC</span><span class="op">)</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">0.80</span> <span class="op">*</span> <span class="va">nC</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">datC_tr</span> <span class="op">&lt;-</span> <span class="va">datC</span><span class="op">[</span><span class="va">id_tr</span>, <span class="op">]</span></span>
<span><span class="va">datC_va</span> <span class="op">&lt;-</span> <span class="va">datC</span><span class="op">[</span><span class="op">-</span><span class="va">id_tr</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># y stays in original units (no transformation)</span></span>
<span><span class="va">y_tr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">datC_tr</span><span class="op">$</span><span class="va">TotalCarbon</span><span class="op">)</span></span>
<span><span class="va">y_va</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">datC_va</span><span class="op">$</span><span class="va">TotalCarbon</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># X: scale predictors using TRAIN center/scale only</span></span>
<span><span class="va">X_tr_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">datC_tr</span><span class="op">$</span><span class="va">spcAMovav</span><span class="op">)</span></span>
<span><span class="va">X_va_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">datC_va</span><span class="op">$</span><span class="va">spcAMovav</span><span class="op">)</span></span>
<span><span class="va">X_te_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">datV</span><span class="op">$</span><span class="va">spcAMovav</span><span class="op">)</span>   <span class="co"># TEST</span></span>
<span></span>
<span><span class="va">X_tr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X_tr_raw</span><span class="op">)</span></span>
<span><span class="va">X_center</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">X_tr</span>, <span class="st">"scaled:center"</span><span class="op">)</span></span>
<span><span class="va">X_scale</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">X_tr</span>, <span class="st">"scaled:scale"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># safe scaling: avoid division by zero</span></span>
<span><span class="va">X_scale</span><span class="op">[</span><span class="va">X_scale</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="va">X_va</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X_va_raw</span>, center <span class="op">=</span> <span class="va">X_center</span>, scale <span class="op">=</span> <span class="va">X_scale</span><span class="op">)</span></span>
<span><span class="va">X_te</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X_te_raw</span>, center <span class="op">=</span> <span class="va">X_center</span>, scale <span class="op">=</span> <span class="va">X_scale</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># sanity checks (dims)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">X_tr</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 234 421</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y_tr</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 234</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">X_va</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  59 421</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y_va</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 59</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">X_te</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  98 421</span></span></code></pre></div>
<p>Prepare Train/Val internal split within datC (no y transform; scale X only)</p>
<p>We model <code>TotalCarbon</code> using the preprocessed spectra matrix <code>spcAMovav</code>.</p>
</div>
<div class="section level3">
<h3 id="fit--evaluate-soilvae-skipped-if-tfkeras-unavailable">Fit + evaluate soilVAE (skipped if TF/Keras unavailable)<a class="anchor" aria-label="anchor" href="#fit--evaluate-soilvae-skipped-if-tfkeras-unavailable"></a>
</h3>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/py_run.html" class="external-link">py_run_string</a></span><span class="op">(</span><span class="st">"</span></span>
<span><span class="st">import os</span></span>
<span><span class="st">import random</span></span>
<span><span class="st">import numpy as np</span></span>
<span><span class="st">import tensorflow as tf</span></span>
<span><span class="st"></span></span>
<span><span class="st">os.environ['PYTHONHASHSEED'] = '0'</span></span>
<span><span class="st">random.seed(19101991)</span></span>
<span><span class="st">np.random.seed(19101991)</span></span>
<span><span class="st">tf.random.set_seed(19101991)</span></span>
<span><span class="st">"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span>TF_DETERMINISTIC_OPS <span class="op">=</span> <span class="st">"1"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span>TF_CPP_MIN_LOG_LEVEL <span class="op">=</span> <span class="st">"2"</span><span class="op">)</span>         <span class="co"># reduce logs INFO/WARN</span></span>
<span><span class="co"># Sys.setenv(TF_ENABLE_ONEDNN_OPTS = "0")</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">has_tf</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"TensorFlow/Keras not available; skipping soilVAE section."</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span>TF_ENABLE_ONEDNN_OPTS<span class="op">=</span><span class="st">"0"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Optional: force a specific python/venv/conda, if needed.</span></span>
<span>  <span class="co"># soilVAE::vae_configure(conda = "soilvae-tf")</span></span>
<span></span>
<span>  <span class="va">grid_vae</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    latent_dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8L</span>, <span class="fl">16L</span>, <span class="fl">32L</span>, <span class="fl">64L</span><span class="op">)</span>,</span>
<span>    dropout    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.20</span>, <span class="fl">0.30</span><span class="op">)</span>,</span>
<span>    lr         <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5e-4</span><span class="op">)</span>,</span>
<span>    beta_kl    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span><span class="op">)</span>,</span>
<span>    alpha_y    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>    epochs     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">500L</span><span class="op">)</span>,</span>
<span>    batch_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">64L</span>, <span class="fl">128L</span><span class="op">)</span>,</span>
<span>    patience   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50L</span><span class="op">)</span>,</span>
<span>    stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">grid_vae</span><span class="op">$</span><span class="va">hidden_enc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">512L</span>, <span class="fl">256L</span>, <span class="fl">128L</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">grid_vae</span><span class="op">$</span><span class="va">hidden_dec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">128L</span>, <span class="fl">256L</span>, <span class="fl">512L</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">tuned</span> <span class="op">&lt;-</span> <span class="fu">soilVAE</span><span class="fu">::</span><span class="fu"><a href="reference/tune_vae_train_val.html">tune_vae_train_val</a></span><span class="op">(</span></span>
<span>    X_tr <span class="op">=</span> <span class="va">X_tr</span>, y_tr <span class="op">=</span> <span class="va">y_tr</span>,</span>
<span>    X_va <span class="op">=</span> <span class="va">X_va</span>, y_va <span class="op">=</span> <span class="va">y_va</span>,</span>
<span>    seed <span class="op">=</span> <span class="fl">19101991</span>,</span>
<span>    grid_vae <span class="op">=</span> <span class="va">grid_vae</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">best</span> <span class="op">&lt;-</span> <span class="fu">soilVAE</span><span class="fu">::</span><span class="fu"><a href="reference/select_best_from_grid.html">select_best_from_grid</a></span><span class="op">(</span><span class="va">tuned</span><span class="op">$</span><span class="va">tuning_df</span>, selection_metric <span class="op">=</span> <span class="st">"euclid"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">cfg</span> <span class="op">&lt;-</span> <span class="va">best</span><span class="op">$</span><span class="va">best</span></span>
<span></span>
<span>  <span class="co"># Refit on full datC (train+val) using early stopping monitored on the internal val (datC_va)</span></span>
<span>  <span class="va">m_vae</span> <span class="op">&lt;-</span> <span class="fu">soilVAE</span><span class="fu">::</span><span class="fu"><a href="reference/vae_build.html">vae_build</a></span><span class="op">(</span></span>
<span>    input_dim  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X_tr</span><span class="op">)</span>,</span>
<span>    hidden_enc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="va">cfg</span><span class="op">$</span><span class="va">hidden_enc_str</span>, <span class="st">"-"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    hidden_dec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="va">cfg</span><span class="op">$</span><span class="va">hidden_dec_str</span>, <span class="st">"-"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    latent_dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">cfg</span><span class="op">$</span><span class="va">latent_dim</span><span class="op">)</span>,</span>
<span>    dropout    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">cfg</span><span class="op">$</span><span class="va">dropout</span><span class="op">)</span>,</span>
<span>    lr         <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">cfg</span><span class="op">$</span><span class="va">lr</span><span class="op">)</span>,</span>
<span>    beta_kl    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">cfg</span><span class="op">$</span><span class="va">beta_kl</span><span class="op">)</span>,</span>
<span>    alpha_y    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">cfg</span><span class="op">$</span><span class="va">alpha_y</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="fu">soilVAE</span><span class="fu">::</span><span class="fu"><a href="reference/vae_fit.html">vae_fit</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="va">m_vae</span>,</span>
<span>    X <span class="op">=</span> <span class="va">X_tr</span>, y <span class="op">=</span> <span class="va">y_tr</span>,</span>
<span>    X_val <span class="op">=</span> <span class="va">X_va</span>, y_val <span class="op">=</span> <span class="va">y_va</span>,</span>
<span>    epochs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">cfg</span><span class="op">$</span><span class="va">epochs</span><span class="op">)</span>,</span>
<span>    batch_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">cfg</span><span class="op">$</span><span class="va">batch_size</span><span class="op">)</span>,</span>
<span>    patience <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">cfg</span><span class="op">$</span><span class="va">patience</span><span class="op">)</span>,</span>
<span>    verbose <span class="op">=</span> <span class="fl">0L</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">yhat_tr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu">soilVAE</span><span class="fu">::</span><span class="fu"><a href="reference/vae_predict.html">vae_predict</a></span><span class="op">(</span><span class="va">m_vae</span>, <span class="va">X_tr</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">yhat_va</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu">soilVAE</span><span class="fu">::</span><span class="fu"><a href="reference/vae_predict.html">vae_predict</a></span><span class="op">(</span><span class="va">m_vae</span>, <span class="va">X_va</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">yhat_te</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu">soilVAE</span><span class="fu">::</span><span class="fu"><a href="reference/vae_predict.html">vae_predict</a></span><span class="op">(</span><span class="va">m_vae</span>, <span class="va">X_te</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Metrics: internal train/val + FINAL TEST</span></span>
<span>  <span class="va">vae_trn</span> <span class="op">&lt;-</span> <span class="fu">eval_quant</span><span class="op">(</span><span class="va">y_tr</span>, <span class="va">yhat_tr</span><span class="op">)</span></span>
<span>  <span class="va">vae_val</span> <span class="op">&lt;-</span> <span class="fu">eval_quant</span><span class="op">(</span><span class="va">y_va</span>, <span class="va">yhat_va</span><span class="op">)</span></span>
<span>  <span class="va">vae_tst</span> <span class="op">&lt;-</span> <span class="fu">eval_quant</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">datV</span><span class="op">$</span><span class="va">TotalCarbon</span><span class="op">)</span>, <span class="va">yhat_te</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Plots</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">y_tr</span>, <span class="va">yhat_tr</span>, main<span class="op">=</span><span class="st">"soilVAE (Train)"</span>, xlab<span class="op">=</span><span class="st">"Observed"</span>, ylab<span class="op">=</span><span class="st">"Predicted"</span>, pch<span class="op">=</span><span class="fl">16</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">y_va</span>, <span class="va">yhat_va</span>, main<span class="op">=</span><span class="st">"soilVAE (Val)"</span>,   xlab<span class="op">=</span><span class="st">"Observed"</span>, ylab<span class="op">=</span><span class="st">"Predicted"</span>, pch<span class="op">=</span><span class="fl">16</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">datV</span><span class="op">$</span><span class="va">TotalCarbon</span><span class="op">)</span>, <span class="va">yhat_te</span>, main<span class="op">=</span><span class="st">"soilVAE (TEST datV)"</span>, xlab<span class="op">=</span><span class="st">"Observed"</span>, ylab<span class="op">=</span><span class="st">"Predicted"</span>, pch<span class="op">=</span><span class="fl">16</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="figure">
<img src="reference/figures/readme-plotting_splits_VAE-1.png" alt="Train/Val splits for soilVAE"><p class="caption">
Train/Val splits for soilVAE
</p>
</div>
</div>
<div class="section level2">
<h2 id="compare-pls-vs-soilvae-test--datv">Compare PLS vs soilVAE (TEST = datV)<a class="anchor" aria-label="anchor" href="#compare-pls-vs-soilvae-test--datv"></a>
</h2>
<p>We present a compact comparison table.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">has_tf</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="va">tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>Model <span class="op">=</span> <span class="st">"PLS"</span>, Split <span class="op">=</span> <span class="st">"Calibration (datC)"</span>, <span class="fu">as_df_metrics</span><span class="op">(</span><span class="va">pls_cal</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>Model <span class="op">=</span> <span class="st">"PLS"</span>, Split <span class="op">=</span> <span class="st">"TEST (datV)"</span>,        <span class="fu">as_df_metrics</span><span class="op">(</span><span class="va">pls_tst</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="va">tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>Model <span class="op">=</span> <span class="st">"PLS"</span>,    Split <span class="op">=</span> <span class="st">"Calibration (datC)"</span>, <span class="fu">as_df_metrics</span><span class="op">(</span><span class="va">pls_cal</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>Model <span class="op">=</span> <span class="st">"PLS"</span>,    Split <span class="op">=</span> <span class="st">"TEST (datV)"</span>,        <span class="fu">as_df_metrics</span><span class="op">(</span><span class="va">pls_tst</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>Model <span class="op">=</span> <span class="st">"soilVAE"</span>,Split <span class="op">=</span> <span class="st">"Train (internal)"</span>,   <span class="fu">as_df_metrics</span><span class="op">(</span><span class="va">vae_trn</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>Model <span class="op">=</span> <span class="st">"soilVAE"</span>,Split <span class="op">=</span> <span class="st">"Val (internal)"</span>,     <span class="fu">as_df_metrics</span><span class="op">(</span><span class="va">vae_val</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>Model <span class="op">=</span> <span class="st">"soilVAE"</span>,Split <span class="op">=</span> <span class="st">"TEST (datV)"</span>,        <span class="fu">as_df_metrics</span><span class="op">(</span><span class="va">vae_tst</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">tab</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">tab</span></span>
<span><span class="co">#&gt;     Model              Split   n    ME  MAE RMSE   R2 RPIQ  RPD</span></span>
<span><span class="co">#&gt; 1     PLS Calibration (datC) 293  0.00 0.37 0.56 0.86 2.04 2.63</span></span>
<span><span class="co">#&gt; 2     PLS        TEST (datV)  98  0.02 0.36 0.52 0.69 2.34 1.81</span></span>
<span><span class="co">#&gt; 3 soilVAE   Train (internal) 234 -0.07 0.31 0.44 0.92 2.54 3.60</span></span>
<span><span class="co">#&gt; 4 soilVAE     Val (internal)  59 -0.10 0.33 0.51 0.76 2.36 2.04</span></span>
<span><span class="co">#&gt; 5 soilVAE        TEST (datV)  98 -0.04 0.33 0.47 0.74 2.56 1.97</span></span></code></pre></div>
<p>If TensorFlow/Keras was not available, you can still use the PLS section and install a compatible Python stack later.</p>
</div>
<div class="section level2">
<h2 id="notes-for-reproducibility">Notes for reproducibility<a class="anchor" aria-label="anchor" href="#notes-for-reproducibility"></a>
</h2>
<ul>
<li><p>The PLS workflow depends only on R packages <code>pls</code> and <code>prospectr</code>.</p></li>
<li><p>The supervised VAE requires:</p></li>
</ul>
<!-- --><div class="sourceCode" id="cb23"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="sc">-</span>   <span class="fu">Python</span> (\<span class="sc">&gt;=</span> <span class="fl">3.9</span>)</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a><span class="sc">-</span>   <span class="fu">TensorFlow</span> (\<span class="sc">&gt;=</span> <span class="fl">2.13</span>)</span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a><span class="sc">-</span>   <span class="fu">Keras</span> (\<span class="sc">&gt;=</span> <span class="dv">3</span>)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="notes-for-life">Notes for life<a class="anchor" aria-label="anchor" href="#notes-for-life"></a>
</h2>
<p><em>Education without ethics is only rhetoric.</em></p>
<p><em>Power without reflection is violence</em></p>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-wadoux2021" class="csl-entry">
Wadoux, Alexandre M. J.-C., Brendan Malone, Budiman Minasny, Mario Fajardo, and Alex B. McBratney. 2021. <em>Soil Spectral Inference with R: Analyzing Digital Soil Spectra Using the R Programming Environment</em>. Progress in Soil Science. Cham: Springer International Publishing. <a href="https://doi.org/10.1007/978-3-030-64896-1" class="external-link uri">https://doi.org/10.1007/978-3-030-64896-1</a>.
</div>
</div>
</div>
</div>

  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/HugoMachadoRodrigues/soilVAE/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/HugoMachadoRodrigues/soilVAE/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing soilVAE</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Hugo Rodrigues <br><small class="roles"> Author, maintainer </small>   </li>
</ul>
</div>



  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Hugo Rodrigues.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
